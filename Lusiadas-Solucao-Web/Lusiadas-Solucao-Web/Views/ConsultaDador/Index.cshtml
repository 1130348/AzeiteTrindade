@using LusiadasDAL;
@using LDFHelper.Helpers;
@using LusiadasSolucaoWeb.Models;

@model Tuple<ConsultaDaDorModel, Tuple<EnfermeirosModel, AnestesistasModel>>

<link href="/Content/css/ldfTable.min.css" rel="stylesheet" />
<script src="/Content/js/ldfTable.min.js"></script>

<!-- Content Header (Page header) -->
<section class="content-header">
    <h1>
        Internamento
        <small>Consulta Da Dor</small>
    </h1>
    <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Início</a></li>
        <li class="active">Consulta Da Dor</li>
    </ol>
</section>

<!-- Main content -->
<section class="content">
    <form action="#" method="post">
        <div class="box box-default">
            <div class="box-body">

            </div>
        </div>
    </form>
</section>

<div class="modal modal-info fade" id="modalPatologia" tabindex="-1" role="dialog" aria-hidden="true" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h4 class="modal-title" id="modal-patologia-title"><i class="fa fa-medkit"></i> Patologia</h4>
            </div>
            <div class="modal-body" id="modal-patologia-body">

            </div>
            <div class="modal-footer">
                <a class="btn btn-default" data-dismiss="modal">Fechar</a>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalHistoricoDaDor" tabindex="-1" role="dialog" aria-hidden="true" style="display: none;">
    <div class="modal-dialog" style="width:1200px;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h4 class="modal-title" id="modal-select-tl-title-histdador"><i class="fa fa-history"></i> Histórico Da Dor</h4>
            </div>
            <div class="modal-body" id="modal-desloc-tl-body-histdador">

            </div>
            <div class="modal-footer">
                <a class="btn btn-default" data-dismiss="modal">Fechar</a>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalFormularioDaDor" role="dialog" aria-hidden="true" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="form-formularioDaDor">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h4 class="modal-title" id="modal-select-tl-title-formDaDor"><i class="fa fa-heartbeat"></i> Formulário Da Dor</h4>
                </div>
                <div class="modal-body" id="modal-desloc-tl-body-formDaDor">
                    @Html.Partial("_formulario", Model.Item2)
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Fechar</button>
                    <button type="submit" class="btn btn-success" id="save-formulario">Gravar</button>
                </div>
            </form>
        </div>
    </div>
</div>
<div class="modal fade" id="modalFormularioDaDorEdit" role="dialog" aria-hidden="true" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="form-formularioDaDorEdit">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h4 class="modal-title" id="modal-select-tl-title-formDaDor"><i class="fa fa-heartbeat"></i> Editar Histórico Da Dor</h4>
                </div>
                <div class="modal-body" id="modal-desloc-tl-body-formDaDorEdit">
                    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Fechar</button>
                    <button type="submit" class="btn btn-success" id="save-formulario-edit">Gravar</button>
                </div>
            </form>
        </div>
    </div>
</div>


@section customJS
{
    <script type="text/javascript">
        var sosCheckBox = $('#SOS').bootstrapSwitch();
        var nauseaCheckBox = $('#NAUSEA').bootstrapSwitch();
        var vomitosCheckBox = $('#VOMITOS').bootstrapSwitch();
        var insoniaCheckBox = $('#INSONIA').bootstrapSwitch();
        var cefaliaCheckBox = $('#CEFALEIA').bootstrapSwitch();
        var altTerapCheckBox = $('#ALT_TERAP').bootstrapSwitch();
        
  
        var dorElement = document.getElementById("DOR");
        noUiSlider.create(dorElement, {
            start: 5,
            step: 1,
            animate: false,
            connect: 'lower',
            range: { 'min': 1, 'max': 10 }
        });

        dorElement.noUiSlider.on('update', function (values, handle) {
            $("#spanSliderDOR").html("Nível: " + values[handle]);
        });

        $("#ENF").select2({ width: "100%" });
        $("#ANEST_VISITA").select2({ width: "100%" });

        $("#form-formularioDaDor").submit(function (e) {
            e.preventDefault();

            var formValues      = {};
            var formSerialize   = $(this).serializeArray();
            formValues = SerializeForm(formValues, formSerialize);
            formValues = FillOptionAndDor(formValues);

            var tDoente = $("#formDaDor_tdoente").val();
            var doente  = $("#formDaDor_doente").val();

            if ($("#formDaDor_rowID").val() === "0") {
                SaveDaDorForm(tDoente, doente, formValues);
            } else {
                EditDaDorForm(tDoente, doente, formValues);
            }
          
        });

        function CloseDaDorForm(result, isEdit)
        {
            result = $.parseJSON(result);
            if (result.header.status == false) {
                alert(result.header.message);
            } else {
                if (isEdit == true)
                    RenderEditData();
                $("#modalFormularioDaDor").modal("hide");
            }
        }

        function SaveDaDorForm(tDoente, doente, formValues)
        {
            var nregoper    = $("#formDaDor_nregoper").val();
            var nint        = $("#formDaDor_nint").val();

            $.ajax({
                url: '@Url.Action("SaveFormularioDaDor", "ConsultaDaDor")',
                data: { "tdoente": tDoente, "doente": doente, "nint": nint, "nregoper": nregoper, "formulario": JSON.stringify(formValues) },
                dataType: 'JSON',
                type: "POST",
                cache: false,
                success: function (result) {
                    CloseDaDorForm(result, false);
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    console.log(xhr);
                }
            });
        }

        function EditDaDorForm(tDoente, doente, formValues) {
            var rowid = $("#formDaDor_rowID").val();

            $.ajax({
                url: '@Url.Action("EditHistoricoTable", "ConsultaDaDor")',
                data: { "tdoente": tDoente, "doente": doente, "rowid": rowid, "formulario": JSON.stringify(formValues) },
                dataType: 'JSON',
                type: "POST",
                cache: false,
                success: function (result) {
                    CloseDaDorForm(result, true);
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    console.log(xhr);
                }
            });
        }

        function RenderEditData()
        {
            var curRow = $("#histDorTable").find("tr[data-rowid='" + $("#formDaDor_rowID").val() + "']");
            $(curRow).find("td[data-column='BAL_INFUSOR']").html($("#BAL_INFUSOR option:selected").text());
            $(curRow).find("td[data-column='BAL_INFUSOR_SIT']").html($("#BAL_INFUSOR_SIT option:selected").text());
            $(curRow).find("td[data-column='ENF']").html($("#ENF option:selected").text());
            $(curRow).find("td[data-column='ANEST_VISITA']").html($("#ANEST_VISITA option:selected").text());
            $(curRow).find("td[data-column='OUTROS_SINT']").html($("#OUTROS_SINT").val());
            $(curRow).find("td[data-column='OBS']").html($("#OBS").val());

            $(curRow).find("td[data-column='SOS']").html(((sosCheckBox.bootstrapSwitch("state") == true) ? "Sim" : "Não"));
            $(curRow).find("td[data-column='NAUSEA']").html((nauseaCheckBox.bootstrapSwitch("state") == true) ? "Sim" : "Não");
            $(curRow).find("td[data-column='VOMITOS']").html((vomitosCheckBox.bootstrapSwitch("state") == true) ? "Sim" : "Não");
            $(curRow).find("td[data-column='INSONIA']").html((insoniaCheckBox.bootstrapSwitch("state") == true) ? "Sim" : "Não");
            $(curRow).find("td[data-column='CEFALEIA']").html((cefaliaCheckBox.bootstrapSwitch("state") == true) ? "Sim" : "Não");
            $(curRow).find("td[data-column='ALT_TERAP']").html((altTerapCheckBox.bootstrapSwitch("state") == true) ? "Sim" : "Não");
            $(curRow).find("td[data-column='DOR']").html(dorElement.noUiSlider.get().split('.')[0]);
            
        }


        $(document).on("click", ".consdadorPatologia", function () {
            var nomeDoente = $(this).attr("data-nome");
            var patologia = $(this).attr("data-patologia");

            $("#modal-patologia-body").html(patologia);

            $("#modal-patologia-title").html("<i class='fa fa-medkit'></i>" + nomeDoente);


        });


        $(document).on("click", ".consdadorFormularioDador", function () {
            var tDoente     = $(this).attr("data-tdoente");
            var doente      = $(this).attr("data-doente");
            var nomeDoente  = $(this).attr("data-nome");
            var nint        = $(this).attr("data-nint");
            var nregoper    = $(this).attr("data-nregoper");

            $("#formDaDor_tdoente").val(tDoente);
            $("#formDaDor_doente").val(doente);
            $("#formDaDor_nint").val(nint);
            $("#formDaDor_nregoper").val(nregoper);
            $("#formDaDor_rowID").val(0);

            sosCheckBox.bootstrapSwitch('state', false);
            nauseaCheckBox.bootstrapSwitch('state', false);
            vomitosCheckBox.bootstrapSwitch('state', false);
            insoniaCheckBox.bootstrapSwitch('state', false);
            cefaliaCheckBox.bootstrapSwitch('state', false);
            altTerapCheckBox.bootstrapSwitch('state', false);

            dorElement.noUiSlider.set(5);

            $("#OUTROS_SINT").val("");
            $("#OBS").val("");

            $("#ENF").select2("val", "");
            $("#ANEST_VISITA").select2("val", "");
        });

        
        $(document).on("click", ".editHistDaDor", function (e) {
            $("#formDaDor_tdoente").val($(this).attr("data-tdoente"));
            $("#formDaDor_doente").val($(this).attr("data-doente"));
            $("#formDaDor_nint").val( $(this).attr("data-nint"));
            $("#formDaDor_nregoper").val($(this).attr("data-nregoper"));
            $("#formDaDor_rowID").val($(this).attr("data-rowid"));

            sosCheckBox.bootstrapSwitch('state', ($(this).attr("data-SOS") === "S" ? true : false));
            nauseaCheckBox.bootstrapSwitch('state', ($(this).attr("data-nausea") === "S" ? true : false));
            vomitosCheckBox.bootstrapSwitch('state', ($(this).attr("data-vomitos") === "S" ? true : false));
            insoniaCheckBox.bootstrapSwitch('state', ($(this).attr("data-insonia") === "S" ? true : false));
            cefaliaCheckBox.bootstrapSwitch('state', ($(this).attr("data-cefaleia") === "S" ? true : false));
            altTerapCheckBox.bootstrapSwitch('state', ($(this).attr("data-altTerap") === "S" ? true : false));

            dorElement.noUiSlider.set($(this).attr("data-dor"));

            $("#OUTROS_SINT").val($(this).attr("data-outrosSint"));
            $("#OBS").val($(this).attr("data-obs"));

            $("#BAL_INFUSOR").val($(this).attr("data-balInfusor"));
            $("#BAL_INFUSOR_SIT").val($(this).attr("data-balInfusorSit"));
            $("#ENF").select2("val", $(this).attr("data-enf"));
            $("#ANEST_VISITA").select2("val", $(this).attr("data-anestVisita"));
        });


        $(document).on("click", ".consdadorHistorico", function () {
            var tDoente     = $(this).attr("data-tdoente");
            var doente      = $(this).attr("data-doente");
            var nomeDoente  = $(this).attr("data-nome");

            $.ajax({
                url: '@Url.Action("ShowHistoricoDaDor", "ConsultaDaDor")',
                data: { "tdoente": tDoente, "doente": doente },
                type: "GET",
                cache: false,
                success: function (result) {
                    if (result != "") {
                        $("#modal-select-tl-title-histdador").html("<i class=\"fa fa-history\"></i> Histórico Da Dor : " + nomeDoente);
                        $("#modal-desloc-tl-body-histdador").html(result);
                    } else {
                        $("#modal-desloc-tl-body-histdador").html("");
                    }
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    console.log(xhr);
                }
            });

        });


        function SerializeForm(formValues, a)
        {
            $.each(a, function () {
                if (formValues[this.name]) {
                    if (!formValues[this.name].push) {
                        formValues[this.name] = [formValues[this.name]];
                    }
                    formValues[this.name].push(this.value || '');
                } else {
                    formValues[this.name] = this.value || '';
                }
            });

            return formValues;
        }

        function FillOptionAndDor(formValues)
        {
            formValues["SOS"] = ((sosCheckBox.bootstrapSwitch("state") == true) ? "S" : "N");
            formValues["NAUSEA"] = ((nauseaCheckBox.bootstrapSwitch("state") == true) ? "S" : "N");
            formValues["VOMITOS"] = ((vomitosCheckBox.bootstrapSwitch("state") == true) ? "S" : "N");
            formValues["INSONIA"] = ((insoniaCheckBox.bootstrapSwitch("state") == true) ? "S" : "N");
            formValues["CEFALEIA"] = ((cefaliaCheckBox.bootstrapSwitch("state") == true) ? "S" : "N");
            formValues["ALT_TERAP"] = ((altTerapCheckBox.bootstrapSwitch("state") == true) ? "S" : "N");
            formValues["DOR"] = dorElement.noUiSlider.get().split('.')[0];

            return formValues;
        }
    </script>

}